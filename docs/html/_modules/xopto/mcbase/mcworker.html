

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>xopto.mcbase.mcworker &mdash; PyXOpto 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> PyXOpto
          

          
            
            <img src="../../../_static/xopto_logo_dark.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/opencl_devices.html">OpenCL devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/mcml/index.html">Layered MC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/mccyl/index.html">Cylindrical MC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/mcvox/index.html">Voxelized MC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/dataset/index.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/modules.html">xopto</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyXOpto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../xopto.html">xopto</a> &raquo;</li>
        
      <li>xopto.mcbase.mcworker</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xopto.mcbase.mcworker</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">################################ Begin license #################################</span>
<span class="c1"># Copyright (C) Laboratory of Imaging technologies,</span>
<span class="c1">#               Faculty of Electrical Engineering,</span>
<span class="c1">#               University of Ljubljana.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of PyXOpto.</span>
<span class="c1">#</span>
<span class="c1"># PyXOpto is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># PyXOpto is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with PyXOpto. If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">################################# End license ##################################</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">xopto.mcbase</span> <span class="kn">import</span> <span class="n">cltypes</span>
<span class="kn">from</span> <span class="nn">xopto.mcbase</span> <span class="kn">import</span> <span class="n">mcobject</span>
<span class="kn">from</span> <span class="nn">xopto.mcbase</span> <span class="kn">import</span> <span class="n">mctypes</span>
<span class="kn">from</span> <span class="nn">xopto.mcbase</span> <span class="kn">import</span> <span class="n">mcoptions</span>
<span class="kn">from</span> <span class="nn">xopto.cl</span> <span class="kn">import</span> <span class="n">clinfo</span>
<span class="kn">from</span> <span class="nn">xopto.cl</span> <span class="kn">import</span> <span class="n">clrng</span>

<span class="kn">from</span> <span class="nn">xopto.mcbase.mcutil.buffer</span> <span class="kn">import</span> \
    <span class="n">RestrictedBufferAllocators</span><span class="p">,</span> <span class="n">BufferAllocator</span><span class="p">,</span> <span class="n">BufferAllocation</span><span class="p">,</span> \
    <span class="n">NumpyAllocators</span><span class="p">,</span> <span class="n">NumpyAllocator</span>

<span class="kn">from</span> <span class="nn">xopto.mcbase.mcutil.lut</span> <span class="kn">import</span> \
    <span class="n">RestrictedLutManagers</span><span class="p">,</span> <span class="n">LutManager</span><span class="p">,</span> <span class="n">LutEntry</span>

<span class="kn">import</span> <span class="nn">pyopencl</span> <span class="k">as</span> <span class="nn">cl</span>


<div class="viewcode-block" id="ClWorker"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker">[docs]</a><span class="k">class</span> <span class="nc">ClWorker</span><span class="p">(</span><span class="n">mcobject</span><span class="o">.</span><span class="n">McObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">types</span><span class="p">:</span> <span class="n">mctypes</span><span class="o">.</span><span class="n">McDataTypesBase</span> <span class="o">=</span> <span class="n">mctypes</span><span class="o">.</span><span class="n">McDataTypesSingle</span><span class="p">,</span>
                 <span class="n">cl_devices</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">cl</span><span class="o">.</span><span class="n">Device</span> <span class="ow">or</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;cl.Device&#39;</span><span class="p">]</span> 
                             <span class="ow">or</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span> <span class="ow">or</span> <span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">cl_build_options</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">cl_profiling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        OpenCL worker with support for allocation of read-write data buffers</span>
<span class="sd">        of arbitrary types and management of read-only lookup tables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        types: mctypes.McDataTypes</span>
<span class="sd">            A class that defines all the simulator data types.</span>
<span class="sd">            Use one of the following predefined type classes derived from</span>
<span class="sd">            mctypes.McDataTypes:</span>

<span class="sd">            - mctypes.McDataTypesSingle</span>

<span class="sd">                - 32-bit size type</span>
<span class="sd">                - 32-bit default integers,</span>
<span class="sd">                - 64-bit detector accumulators,</span>
<span class="sd">                - single precision floating-point arithmetics,</span>
<span class="sd">                - 32-bit photon packet counter (maximum number of photon</span>
<span class="sd">                    packets per OpenCL kernel call limited to 4,294,967,295)</span>

<span class="sd">            - mctypes.McDataTypesDouble</span>

<span class="sd">                - 32-bit size type,</span>
<span class="sd">                - 32-bit default integers,</span>
<span class="sd">                - 64-bit detector accumulators,</span>
<span class="sd">                - double precision floating-point arithmetics,</span>
<span class="sd">                - 32-bit photon packet counter (maximum number of photon</span>
<span class="sd">                    packets per OpenCL kernel call limited to 4,294,967,295)</span>

<span class="sd">            - mctypes.McDataTypesSingleCnt64</span>

<span class="sd">                - 64-bit size type,</span>
<span class="sd">                - 32-bit default integers,</span>
<span class="sd">                - 64-bit detector accumulators,</span>
<span class="sd">                - single precision floating-point arithmetics,</span>
<span class="sd">                - 64-bit photon packet counter (maximum number of photon</span>
<span class="sd">                    packets per OpenCL kernel call virtually unlimited)</span>

<span class="sd">            - mctypes.McDataTypesDoubleCnt64</span>

<span class="sd">                - 64-bit size type,</span>
<span class="sd">                - 32-bit default integers,</span>
<span class="sd">                - 64-bit detector accumulators,</span>
<span class="sd">                - double precision floating-point arithmetics,</span>
<span class="sd">                - 32-bit photon packet counter (maximum number of photon</span>
<span class="sd">                    packets per OpenCL kernel call virtually unlimited)</span>

<span class="sd">        cl_devices: str or cl.Device or List[cl.Device] or cl.Context cl.CommnadQueue</span>
<span class="sd">            A python list of OpenCL devices that are used for</span>
<span class="sd">            conducting the simulation. See the clGpuDevices and clCpuDevices</span>
<span class="sd">            functions of the :py:mod:`xopto.clinfo` module for details on</span>
<span class="sd">            obtaining a list of OpenCl capable devices. If None is provided,</span>
<span class="sd">            the first available device is used (GPU devices have priority over</span>
<span class="sd">            CPU devices). Use function :py:func:`xopto.clinfo.device` to get</span>
<span class="sd">            a desired device by simple keywords, e.g. a call</span>
<span class="sd">            clinfo.device([&#39;amd&#39;, &#39;nvidia&#39;, &#39;hd&#39;, &#39;cpu&#39;], that will search</span>
<span class="sd">            for an AMD GPU, Nvidia GPU, Intel Hd GPU, any CPU and return</span>
<span class="sd">            the first device found.</span>
<span class="sd">            The value of this input argument can also be an</span>
<span class="sd">            instance of OpenCL Context or an instance of OpenCL CommandQueue.</span>
<span class="sd">            Note that in case an instance of CommandQueue is passed, the value</span>
<span class="sd">            of parameter cl_profiling is ignored since it is not possible to</span>
<span class="sd">            enable or disable profiling on an existing OpenCL CommandQueue.</span>

<span class="sd">        cl_build_options: List[str]</span>
<span class="sd">            A list of OpenCL build option as specified by the OpenCl manuals at</span>
<span class="sd">            https://www.khronos.org/.</span>
<span class="sd">            An example of commonly used build options:</span>
<span class="sd">            cloptions=[&#39;-cl-opt-disable&#39;, &#39;-Werror&#39;, &#39;-cl-fast-relaxed-math&#39;, &#39;-cl-mad-enable&#39;].</span>

<span class="sd">        cl_profiling: bool</span>
<span class="sd">            Enables OpenCL command queue profiling.</span>
<span class="sd">            Note that in case an instance of CommandQueue is passed as the</span>
<span class="sd">            cl_devices parameter, the value of parameter cl_profiling is</span>
<span class="sd">            ignored since it is not possible to enable or disable profiling</span>
<span class="sd">            on an existing OpenCL CommandQueue.</span>

<span class="sd">        kwargs: dict</span>
<span class="sd">            Keyword arguments passed to the Mixin classes.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Use the :py:meth:`create_allocator` method to create buffer allocators</span>
<span class="sd">        and the :py:meth:`create_lut_manager` method to create managers of</span>
<span class="sd">        lookup tables.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Data types that will be used by this simulator instance.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">mctypes</span><span class="o">.</span><span class="n">McDataTypesBase</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;The types argument must be a subclass of McDataTypes!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="n">types</span>

        <span class="c1"># Allocators for read-write OpenCL buffers that are passed to the</span>
        <span class="c1"># OpenCL kernels as a single buffer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span> <span class="o">=</span> <span class="n">RestrictedBufferAllocators</span><span class="p">(</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">np_accu</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">))</span>
        <span class="c1"># OpenCL buffers that are produced by the allocators of read-write</span>
        <span class="c1"># OpenCL buffers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators_buffers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Allocators for temporary numpy data buffers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_np_allocators</span> <span class="o">=</span> <span class="n">NumpyAllocators</span><span class="p">()</span>

        <span class="c1"># Storage for all the read-only lookup table managers used by this object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_r_lut_managers</span><span class="o">=</span> <span class="n">RestrictedLutManagers</span><span class="p">(</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">))</span>

        <span class="c1"># Numpy data buffers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_np_buffers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># OpenCL data buffers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Save the list of OpenCL devices</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_devices</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_devices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_devices</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">clinfo</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">cl_devices</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_devices</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="o">=</span> <span class="n">cl_devices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="o">.</span><span class="n">devices</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_devices</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span> <span class="o">=</span> <span class="n">cl_devices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="o">.</span><span class="n">context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="o">.</span><span class="n">devices</span>
            <span class="n">cl_profiling</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="o">.</span><span class="n">properties</span> <span class="o">&amp;</span> 
                <span class="n">cl</span><span class="o">.</span><span class="n">command_queue_properties</span><span class="o">.</span><span class="n">PROFILING_ENABLE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_profiling</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cl_profiling</span><span class="p">)</span>
        <span class="n">cl_cq_properties</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_profiling</span><span class="p">:</span>
            <span class="n">cl_cq_properties</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">command_queue_properties</span><span class="o">.</span><span class="n">PROFILING_ENABLE</span>

        <span class="c1"># OpenCL build options</span>
        <span class="k">if</span> <span class="n">cl_build_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cl_build_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_build_options</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cl_build_options</span><span class="p">]</span>

        <span class="c1"># The OpenCL context used by the worker.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span><span class="p">)</span>
        <span class="c1"># The OpenCL queue used by the worker.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">cl_cq_properties</span><span class="p">)</span>
        <span class="c1"># The latest executable build with this the worker.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_exec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># a dict lookup for type names from numpy dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_to_type_str</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">):</span> <span class="s1">&#39;uint64&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">):</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint32&#39;</span><span class="p">):</span> <span class="s1">&#39;uint32&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">):</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint16&#39;</span><span class="p">):</span> <span class="s1">&#39;uint16&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">):</span> <span class="s1">&#39;int16&#39;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">):</span> <span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">):</span> <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">):</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">):</span> <span class="s1">&#39;double&#39;</span>
        <span class="p">}</span>

<div class="viewcode-block" id="ClWorker.event_timing"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.event_timing">[docs]</a>    <span class="k">def</span> <span class="nf">event_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If OpenCL profiling is enabled, the timing related to an OpenCL event</span>
<span class="sd">        can be retrieved through the profile property of the event:</span>

<span class="sd">        - ev.profile.queued   - nanosecond counter captured on event queued</span>
<span class="sd">        - ev.profile.submit   - nanosecond counter captured on event submitted</span>
<span class="sd">        - ev.profile.start    - nanosecond counter captured on start of execution</span>
<span class="sd">        - ev.profile.complete - nanosecond counter captured on end of execution</span>

<span class="sd">        This method returns the time (s) that was required to start executing</span>
<span class="sd">        of the command and the time (s) required to execute the command.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event: cl.Event</span>
<span class="sd">            OpenCL event instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dt_delay: float</span>
<span class="sd">            Time (s) that was required to start the execution of the command</span>
<span class="sd">            (profile.start - profile.submit).</span>
<span class="sd">        dt_exec: float</span>
<span class="sd">            Time (s) that was required to execute the command</span>
<span class="sd">            (profile.complete - profile.start).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_profiling</span><span class="p">:</span>
            <span class="k">return</span>  <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> \
                    <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">complete</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span></div>

<div class="viewcode-block" id="ClWorker.cl_build"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_build">[docs]</a>    <span class="k">def</span> <span class="nf">cl_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl_src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Build OpenCL source code. A context and command queue are created on</span>
<span class="sd">        the first run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cl_src: str</span>
<span class="sd">            OpenCL source code as a string.</span>
<span class="sd">        verbose: bool</span>
<span class="sd">            Turns on verbose reporting.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        program: cl.Program</span>
<span class="sd">            OpenCL executable.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_src</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The openCl source code must be a string!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cl_devices</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_profiling</span><span class="p">:</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">command_queue_properties</span><span class="o">.</span><span class="n">PROFILING_ENABLE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Executing OpenCL code on: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="o">.</span><span class="n">devices</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OpenCL build options:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_build_options</span><span class="p">)</span>

        <span class="n">tb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">cl_exec</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">cl_src</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cl_build_options</span><span class="p">)</span>
        <span class="c1"># options=[&#39;-cl-opt-disable&#39;, &#39;-Werror&#39;]</span>
        <span class="n">buildtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">tb</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source code built in </span><span class="si">{:.3f}</span><span class="s1"> ms.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">buildtime</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cl_exec</span></div>

    <span class="k">def</span> <span class="nf">_get_cl_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">Device</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="o">.</span><span class="n">devices</span>
    <span class="n">cl_device</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_device</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;OpenCL device that is used to run this simulator &#39;</span>
                         <span class="s1">&#39;instance. &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Context</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span>
    <span class="n">cl_context</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_context</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;OpenCL context.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_build_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_build_options</span>
    <span class="n">cl_build_options</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_build_options</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;Returns a tuple of OpenCL build options &#39;</span>
                                <span class="s1">&#39;that were passed to the constructor.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_profiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_profiling</span>
    <span class="n">cl_profiling</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_profiling</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;Returns True if OpenCL command queue &#39;</span>
                            <span class="s1">&#39;allows profiling.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span>
    <span class="n">cl_queue</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_queue</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;OpenCL command queue.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_exec</span>
    <span class="n">cl_exec</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_exec</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="s1">&#39;The latest OpenCL program built with this worker.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ClWorker.dtype_to_typename"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.dtype_to_typename">[docs]</a>    <span class="k">def</span> <span class="nf">dtype_to_typename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a standard short type name for the given numpy data type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Numpy data type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        typename: str</span>
<span class="sd">            A short standard type name for the given numpy data type.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_to_type_str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The provided numpy data type is not supported!&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name</span></div>

    <span class="k">def</span> <span class="nf">np_allocators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyAllocators</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get allocators of temporary numpy buffers.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        allocators: NumpyAllocators</span>
<span class="sd">            Numpy allocators of temporary buffers.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_np_allocators</span>

<div class="viewcode-block" id="ClWorker.cl_rw_allocator"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_rw_allocator">[docs]</a>    <span class="k">def</span> <span class="nf">cl_rw_allocator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferAllocator</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns OpenCL read-write buffer allocator for the give data type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Numpy data type used with the allocator.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        allocator: BufferAllocator</span>
<span class="sd">            Buffer allocator for the given data type.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span></div>

<div class="viewcode-block" id="ClWorker.cl_allocate_rw_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_allocate_rw_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_allocate_rw_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span>
                              <span class="nb">tuple</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Allocate a read-write OpenCL buffer of the given data type using</span>
<span class="sd">        the related OpenCL buffer allocator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Numpy data type of the buffer allocator.</span>
<span class="sd">        owner: any</span>
<span class="sd">            Object that will own the allocated buffer.</span>
<span class="sd">        shape: Tuple[int]</span>
<span class="sd">            Shape of the buffer array to allocate.</span>
<span class="sd">        download: bool</span>
<span class="sd">            Set to True if the data buffer should be downloaded after</span>
<span class="sd">            executing the kernel.</span>
<span class="sd">            The downloaded data will be passed to the :py:meth:`update_data`</span>
<span class="sd">            of the owner.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            Buffer allocation object with information on the allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span>
            <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorker.cl_rw_allocator_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_rw_allocator_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_rw_allocator_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fetch the OpenCL read-write buffer of the allocator for the given</span>
<span class="sd">        data type.</span>
<span class="sd">        A new OpenCL buffer is created on the first call. A new OpenCL buffer</span>
<span class="sd">        is also allocated if the size of the existing buffer is too small for</span>
<span class="sd">        the allocations.</span>
<span class="sd">        The fill argument can be used to initialize the buffer with the given</span>
<span class="sd">        value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Buffer allocator data type.</span>
<span class="sd">        fill: np.dtype.type</span>
<span class="sd">            If not None, initialize the buffer with the given value / fill.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            OpenCL read-write buffer of the allocator.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">allocator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">allocator</span><span class="p">)</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="o">*</span><span class="n">allocator</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">cl_buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cl_buffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">:</span>
            <span class="c1"># an OpenCL buffer does not exist yet - create one</span>
            <span class="k">if</span> <span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators_buffers</span><span class="p">[</span><span class="n">allocator</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>

        <span class="k">if</span> <span class="n">fill</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cl_w_buffer_fill</span><span class="p">(</span><span class="n">cl_buffer</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cl_buffer</span></div>

<div class="viewcode-block" id="ClWorker.cl_w_buffer_fill"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_w_buffer_fill">[docs]</a>    <span class="k">def</span> <span class="nf">cl_w_buffer_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl_buffer</span><span class="p">:</span><span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                         <span class="n">fill</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">cl_kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fast fill of writable OpenCL buffers with a given scalar value. </span>

<span class="sd">        The OpenCL buffer must be writable, since the initialization is</span>
<span class="sd">        performed in an OpenCL kernel!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cl_buffer: cl.Buffer</span>
<span class="sd">            The OpenCL buffer to fill.</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Numpy dtype of a buffer element/item.</span>
<span class="sd">        fill: int or float</span>
<span class="sd">            Scalar value used as a buffer fill. Must be convertible to</span>
<span class="sd">            the given data type (dtype).</span>
<span class="sd">        size: int</span>
<span class="sd">            The last item of the buffer relative to the offset that will be</span>
<span class="sd">            filled. If None, the entire buffer from the offset will be filled.</span>
<span class="sd">            Note that the size is given in buffer items not bytes!</span>
<span class="sd">        offset: int</span>
<span class="sd">            First item of the buffer that will be filled.</span>
<span class="sd">            Note that the size is given in buffer items not bytes!</span>
<span class="sd">        cl_kernel: cl.Kernel</span>
<span class="sd">            OpenCL kernel that will be used to fill the buffer. If None,</span>
<span class="sd">            a matching kernel will be searched in the current executable</span>
<span class="sd">            :py:attr:`cl_exec`. The fill kernels must follow the</span>
<span class="sd">            following footprint:</span>

<span class="sd">            .. code-block::</span>

<span class="sd">                fill_&lt;dtype&gt;(__global T *buffer, T fill_value,</span>
<span class="sd">                             mc_size_t size, mc_size_t offset)</span>

<span class="sd">            where dtype should be one of (double, float, int64, uint64,</span>
<span class="sd">            int32 or uint32).</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Note that the size and offset are given in buffer items not bytes!</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_kernel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype_to_typename</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">kernel_name</span> <span class="o">=</span> <span class="s1">&#39;fill_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
            <span class="n">cl_kernel</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_exec</span><span class="p">,</span> <span class="n">kernel_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cl_kernel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;No fill kernel is defined for the given &#39;</span>
                                <span class="s1">&#39;data type </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

        <span class="n">cl_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cl_buffer</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">cl_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Fill offset exceeds the OpenCL buffer size!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">cl_size</span> <span class="o">-</span> <span class="n">offset</span>
        <span class="k">elif</span> <span class="n">size</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">cl_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Fill range (offset: offset + size) exceeds &#39;</span>
                             <span class="s1">&#39;the OpenCL buffer size!&#39;</span><span class="p">)</span>

        <span class="n">dtype_sizet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_size</span><span class="p">)</span>
        <span class="n">cl_kernel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_queue</span><span class="p">,</span> <span class="p">(</span><span class="n">cl_size</span><span class="p">,</span> <span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cl_buffer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">fill</span><span class="p">),</span>
                  <span class="n">dtype_sizet</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype_sizet</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="ClWorker.r_lut_manager"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.r_lut_manager">[docs]</a>    <span class="k">def</span> <span class="nf">r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LutManager</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a read-only lookup table manager that matches the given</span>
<span class="sd">        data type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Data type managed by the lookup table manager.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_lut_managers</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span></div>

<div class="viewcode-block" id="ClWorker.append_r_lut_data"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.append_r_lut_data">[docs]</a>    <span class="k">def</span> <span class="nf">append_r_lut_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LutEntry</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add a read-only lookup table data array to the list of managed</span>
<span class="sd">        lookup table arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Data type of the lookup table manager.</span>
<span class="sd">        data: np.ndarray</span>
<span class="sd">            Lookup table data to be added to the managed list. The numpy</span>
<span class="sd">            array must be of a type that can be converted to the data</span>
<span class="sd">            type of the lookup table manager.</span>
<span class="sd">        force: bool</span>
<span class="sd">            Add the array to the managed list even if an existing entry for the</span>
<span class="sd">            given data array is found.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lutentry: LutEntry</span>
<span class="sd">            Lookup table entry. Use the :py:attr:LutEntry.offset</span>
<span class="sd">            to get the offset of the first element in the common data array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_lut_managers</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorker.cl_r_lut_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_r_lut_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_r_lut_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns an OpenCL buffer (create if not exist) representing the</span>
<span class="sd">        read-only data arrays managed by the related read-only lookup</span>
<span class="sd">        table manager.</span>
<span class="sd">        The value of update argument controls if the content of the OpenCL</span>
<span class="sd">        buffer is updated with the content of the managed arrays.</span>
<span class="sd">        If an OpenCL buffer does not exist, a new one is created and updated</span>
<span class="sd">        regardless of the value of the update argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype: np.dtype</span>
<span class="sd">            Data type of the lookup table manager.</span>
<span class="sd">        update: bool</span>
<span class="sd">            If True, update the flat numpy array  with the</span>
<span class="sd">            current content of the managed lookup tables.</span>
<span class="sd">            If an OpenCL buffer does not exist, a new is created and updated</span>
<span class="sd">            regardless of the value of the update argument.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cl_float_lut: cl.Buffer</span>
<span class="sd">            OpenCL buffer of the floating-point lookup table array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">lut_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_lut_managers</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lut_manager</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">np_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_np_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lut_manager</span><span class="p">)</span>
            <span class="n">np_buffer</span> <span class="o">=</span> <span class="n">lut_manager</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="n">np_buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_np_buffers</span><span class="p">[</span><span class="n">lut_manager</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_buffer</span> 

            <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cl_lut_buffer</span><span class="p">(</span>
                <span class="n">lut_manager</span><span class="p">,</span> <span class="n">np_buffer</span><span class="o">=</span><span class="n">np_buffer</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cl_buffer</span></div>

    <span class="k">def</span> <span class="nf">_get_cl_lut_buffer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">lut_manager</span><span class="p">:</span> <span class="n">BufferAllocator</span><span class="p">,</span>
            <span class="n">np_buffer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">access</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Internal method that returns an existing or creates a new numpy data</span>
<span class="sd">        array-based read-write or read-only OpenCL buffer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lut_manager: str</span>
<span class="sd">            Lookup table manager.</span>
<span class="sd">        np_buffer: np.ndarray</span>
<span class="sd">            Numpy data buffer used as initializer.</span>
<span class="sd">        access: &#39;r&#39; or &#39;rw&#39;</span>
<span class="sd">            Access flags for the OpenCL buffer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            OpenCL buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># allocate and initialize the buffer</span>
        <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lut_manager</span><span class="p">)</span>
        
        <span class="n">mf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rw&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span>
              <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_ONLY</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="s1">&#39;rw&#39;</span><span class="p">)</span>
        <span class="n">mf_cp_host</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span>
    
        <span class="k">if</span> <span class="n">cl_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the OpenCL buffer does not exist yet - create one</span>
            <span class="k">if</span> <span class="n">np_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np_buffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">lut_manager</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">mf</span> <span class="o">|</span> <span class="n">mf_cp_host</span><span class="p">,</span>
                        <span class="n">hostbuf</span><span class="o">=</span><span class="n">np_buffer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">lut_manager</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span>
                    <span class="n">lut_manager</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np_buffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np_buffer</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">==</span> <span class="n">cl_buffer</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="p">,</span>
                        <span class="n">cl_buffer</span><span class="p">,</span>
                        <span class="n">np_buffer</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Allocating a new lut OpenCL Buffer!&#39;</span><span class="p">,</span> <span class="n">cl_buffer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">lut_manager</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">mf</span> <span class="o">|</span> <span class="n">mf_cp_host</span><span class="p">,</span>
                        <span class="n">hostbuf</span><span class="o">=</span><span class="n">np_buffer</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">lut_manager</span><span class="p">]</span>

<div class="viewcode-block" id="ClWorker.cl_rw_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_rw_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_rw_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a read-write OpenCL buffer and optionally initialize the buffer</span>
<span class="sd">        with data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            A unique name for the buffer.</span>
<span class="sd">        data: any object with a buffer interface</span>
<span class="sd">            Initializer for the OpenCl buffer.</span>
<span class="sd">        size: int</span>
<span class="sd">            Size of the buffer in bytes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            The OpenCL buffer.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        One of the size or data input arguments must be defined. If both</span>
<span class="sd">        are defined, data will be used to derive the size and initialize</span>
<span class="sd">        the OpenCL buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot create an OpenCL buffer if the initialization &#39;</span>
                    <span class="s1">&#39;data and the buffer size are unknown!&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span> <span class="o">|</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span><span class="p">,</span>
                    <span class="n">hostbuf</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>

        <span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cl_buffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span> <span class="o">|</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span><span class="p">,</span>
                    <span class="n">hostbuf</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="p">,</span>
                        <span class="n">cl_buffer</span><span class="p">,</span>
                        <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cl_buffer</span></div>

<div class="viewcode-block" id="ClWorker.cl_w_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_w_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_w_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a write only OpenCL buffer and optionally initialize the buffer</span>
<span class="sd">        with data. If a buffer of equal or larger size is found for the</span>
<span class="sd">        given name, a new buffer is not created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            A unique name for the buffer.</span>
<span class="sd">        size: int</span>
<span class="sd">            Size of the buffer in bytes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            The opencl buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot create an OpenCL buffer if the size of the buffer&#39;</span>
                    <span class="s1">&#39;is unknown!&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">WRITE_ONLY</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cl_buffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">WRITE_ONLY</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>

        <span class="k">return</span> <span class="n">cl_buffer</span></div>

<div class="viewcode-block" id="ClWorker.cl_r_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_r_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_r_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a read-only OpenCL buffer and optionally initialize the buffer</span>
<span class="sd">        with data. If a buffer of equal or larger size is found for the</span>
<span class="sd">        given name, a new buffer is not created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            A unique name for the buffer.</span>
<span class="sd">        data: any object with a buffer interface</span>
<span class="sd">            Initializer for the OpenCl buffer.</span>
<span class="sd">        size: int</span>
<span class="sd">            Size of the buffer in bytes.</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            The OpenCL buffer.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        One of the size or data input arguments must be defined. If both</span>
<span class="sd">        are defined, data will be used to derive the size and initialize</span>
<span class="sd">        the OpenCL buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cl_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot create an OpenCL buffer if the initialization &#39;</span>
                    <span class="s1">&#39;data and the buffer size are unknown!&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_ONLY</span> <span class="o">|</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span><span class="p">,</span>
                    <span class="n">hostbuf</span><span class="o">=</span><span class="n">data</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_ONLY</span><span class="p">,</span> <span class="n">size</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>

        <span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">cl_buffer</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">cl_buffer</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_context</span><span class="p">,</span>
                        <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">READ_WRITE</span> <span class="o">|</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span><span class="p">,</span>
                        <span class="n">hostbuf</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_buffer</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="p">,</span>
                            <span class="n">cl_buffer</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cl_buffer</span></div>

    <span class="k">def</span> <span class="nf">_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cltypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="ClWorker.cl_allocation_download"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_allocation_download">[docs]</a>    <span class="k">def</span> <span class="nf">cl_allocation_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allocation</span><span class="p">:</span> <span class="n">BufferAllocation</span><span class="p">,</span>
                               <span class="n">out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Download the content of the allocated buffer from the OpenCL device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            Buffer allocation as returned by the</span>
<span class="sd">            :py:meth:`allocate_buffer` methods.</span>
<span class="sd">        out: np.ndarray</span>
<span class="sd">            Optional target numpy data array that will be filled with the</span>
<span class="sd">            content of the OpenCL buffer.</span>
<span class="sd">            The type and size of the numpy array must match the allocation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out: np.ndarray</span>
<span class="sd">            Numpy data array that is filled with the OpenCL buffer content.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">allocation</span><span class="o">.</span><span class="n">allocator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Buffer allocation was not made by this object!&#39;</span><span class="p">)</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">allocation</span><span class="o">.</span><span class="n">offset</span><span class="o">*</span><span class="n">allocation</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">allocation</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">allocation</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># a permissive check</span>
        <span class="k">elif</span> <span class="n">out</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">!=</span> <span class="n">allocation</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">allocation</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The output buffer does not match the type and/or size of &#39;</span>
                <span class="s1">&#39;the allocation!&#39;</span><span class="p">)</span>
        
        <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffer_from_allocation</span><span class="p">(</span><span class="n">allocation</span><span class="p">),</span>
            <span class="n">device_offset</span><span class="o">=</span><span class="n">offset</span>
        <span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ClWorker.cl_allocation_upload"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorker.cl_allocation_upload">[docs]</a>    <span class="k">def</span> <span class="nf">cl_allocation_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allocation</span><span class="p">:</span> <span class="n">BufferAllocation</span><span class="p">,</span>
                             <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Upload an allocated OpenCL buffer from host to the OpenCL device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            Buffer allocation as returned by the</span>
<span class="sd">            :py:meth:`cl_allocate_rw_int_buffer` or</span>
<span class="sd">            :py:meth:`cl_allocate_rw_accumulator_buffer` or</span>
<span class="sd">            :py:meth:`cl_allocate_rw_accumulator_buffer` methods.</span>
<span class="sd">        data: np.ndarray</span>
<span class="sd">            Data array to be uploaded. The type and size of the numpy array</span>
<span class="sd">            must match the allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">allocation</span><span class="o">.</span><span class="n">allocator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Buffer allocation was not made by this object!&#39;</span><span class="p">)</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">allocation</span><span class="o">.</span><span class="n">offset</span><span class="o">*</span><span class="n">allocation</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">if</span> <span class="n">allocation</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">or</span> <span class="n">allocation</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The data buffer does not match the type and/or size of &#39;</span>
                <span class="s1">&#39;the allocation!&#39;</span><span class="p">)</span>
        
        <span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffer_from_allocation</span><span class="p">(</span><span class="n">allocation</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">device_offset</span><span class="o">=</span><span class="n">offset</span>
        <span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_cl_buffer_from_allocation</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">allocation</span><span class="p">:</span> <span class="n">BufferAllocation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Internal method that fetches an OpenCl buffer related to the</span>
<span class="sd">        given allocation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            Buffer allocation object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cl_buffer: cl.Buffer</span>
<span class="sd">            OpenCL buffer related to the allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators_buffers</span><span class="p">[</span><span class="n">allocation</span><span class="o">.</span><span class="n">allocator</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_cl_rw_allocators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RestrictedBufferAllocators</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_rw_allocators</span>
    <span class="n">cl_rw_allocators</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_rw_allocators</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;Allocators of OpenCL buffers.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_np_allocators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyAllocators</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_np_allocators</span>
    <span class="n">np_allocators</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_np_allocators</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;Allocators of temporary numpy buffers.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mctypes</span><span class="o">.</span><span class="n">McDataTypesBase</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span>
    <span class="n">types</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_types</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s1">&#39;Data types used by the OpenCL kernel.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_np_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_np_buffers</span>
    <span class="n">np_buffers</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_np_buffers</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Numpy data buffers.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_buffers</span>
    <span class="n">cl_buffers</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_buffers</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;OpenCL data buffers.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin">[docs]</a><span class="k">class</span> <span class="nc">ClWorkerStandardBufferLutMixin</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ClWorker class mixin that creates interfaces for a</span>
<span class="sd">    standard set of OpenCL read-write buffer allocators and read-ony lookup</span>
<span class="sd">    table managers.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_get_float_r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LutManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">)</span>
    <span class="n">float_r_lut_manager</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_float_r_lut_manager</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Floating-point read-only data lookup table manager.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_int_r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LutManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">)</span>
    <span class="n">int_r_lut_manager</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_int_r_lut_manager</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Integer read-only data lookup table manager.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_rw_accumulator_allocator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferAllocator</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_rw_allocator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_accu</span><span class="p">)</span>
    <span class="n">cl_rw_accumulator_allocator</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_cl_rw_accumulator_allocator</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Allocator of read-write accumulator type OpenCL buffers.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_rw_float_allocator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferAllocator</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_rw_allocator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">)</span>
    <span class="n">cl_rw_float_allocator</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_cl_rw_float_allocator</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Allocator of read-write floating-point type OpenCL buffers.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_rw_int_allocator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferAllocator</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_rw_allocator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">)</span>
    <span class="n">cl_rw_int_allocator</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_cl_rw_int_allocator</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Allocator of read-write integer type OpenCL buffers.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_r_float_lut"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_r_float_lut">[docs]</a>    <span class="k">def</span> <span class="nf">cl_r_float_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns an OpenCL buffer (create if not exist) representing the</span>
<span class="sd">        read-only data arrays managed by the floating-point lookup table</span>
<span class="sd">        manager.</span>
<span class="sd">        The value of update argument controls if the content of the OpenCL</span>
<span class="sd">        buffer is updated with the content of the managed arrays.</span>
<span class="sd">        If an OpenCL buffer does not exist, a new is created and updated</span>
<span class="sd">        regardless of the value of the update argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        update: bool</span>
<span class="sd">            If True, update the flat numpy array of lookup tables with the</span>
<span class="sd">            current content of the managed lookup tables.</span>
<span class="sd">            If an OpenCL buffer does not exist, a new one is created and</span>
<span class="sd">            updated regardless of the value of the update argument.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cl_float_lut: cl.Buffer</span>
<span class="sd">            OpenCL buffer of the floating-point lookup table array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_r_lut_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_r_int_lut"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_r_int_lut">[docs]</a>    <span class="k">def</span> <span class="nf">cl_r_int_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns an OpenCL buffer (create if not exist) representing the</span>
<span class="sd">        read-only integer arrays managed by the integer lookup table</span>
<span class="sd">        manager.</span>
<span class="sd">        The value of update argument controls if the content of the OpenCL</span>
<span class="sd">        buffer is updated with the content of the managed arrays.</span>
<span class="sd">        If an OpenCL buffer does not exist, a new one is created and updated</span>
<span class="sd">        regardless of the value of the update argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        update: bool</span>
<span class="sd">            If True, update the flat numpy array of lookup tables with the</span>
<span class="sd">            current content of the managed lookup tables.</span>
<span class="sd">            If an OpenCL buffer does not exist, a new one is created and</span>
<span class="sd">            updated regardless of the value of the update argument.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cl_float_lut: cl.Buffer</span>
<span class="sd">            OpenCL buffer of the floating-point lookup table array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_r_lut_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_rw_accumulator_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_rw_accumulator_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_rw_accumulator_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fetch the OpenCL buffer of the accumulator allocator.</span>
<span class="sd">        A new OpenCL buffer is created on the first call.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fill: int</span>
<span class="sd">            Scalar value used to fill the buffer. Must be convertible to</span>
<span class="sd">            the given data type (dtype).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            OpenCL buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_rw_allocator_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_accu</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_rw_float_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_rw_float_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_rw_float_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fetch the OpenCL buffer of the floating-point allocator.</span>
<span class="sd">        A new OpenCL buffer is created on the first call.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fill: float</span>
<span class="sd">            Scalar value used to fill the buffer. Must be convertible to</span>
<span class="sd">            the given data type (dtype).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            OpenCL buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_rw_allocator_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_rw_int_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_rw_int_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_rw_int_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fetch the OpenCL buffer of the integer allocator.</span>
<span class="sd">        A new OpenCL buffer is created on the first call.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fill: int</span>
<span class="sd">            Scalar value used to fill the buffer. Must be convertible to</span>
<span class="sd">            the given data type (dtype).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffer: cl.Buffer</span>
<span class="sd">            OpenCL buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_rw_allocator_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_allocate_rw_accumulator_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_allocate_rw_accumulator_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_allocate_rw_accumulator_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                          <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">BufferAllocation</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Allocate a new read-write accumulator buffer with OpenCL type mc_accu_t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        owner: any</span>
<span class="sd">            Allocation owner / caller.</span>
<span class="sd">        shape: Tuple[int]</span>
<span class="sd">            Allocation buffer shape.</span>
<span class="sd">        download: bool</span>
<span class="sd">            Set to True if download is required after executing the kernel.</span>
<span class="sd">            The downloaded data will be passed to the :py:meth:`update_data`</span>
<span class="sd">            method of the owner.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            The buffer allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_allocate_rw_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_accu</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
                                          <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_allocate_rw_float_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_allocate_rw_float_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_allocate_rw_float_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
                                    <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferAllocator</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Allocate a new read-write floating-point buffer with OpenCL type mc_fp_t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        owner: any</span>
<span class="sd">            Allocation owner / caller.</span>
<span class="sd">        shape: Tuple[int]</span>
<span class="sd">            Allocation buffer shape.</span>
<span class="sd">        download: bool</span>
<span class="sd">            Set to True if download is required after executing the kernel.</span>
<span class="sd">            The downloaded data will be passed to the :py:meth:`update_data`</span>
<span class="sd">            method of the owner.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            The buffer allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_allocate_rw_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
                                          <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.cl_allocate_rw_int_buffer"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.cl_allocate_rw_int_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">cl_allocate_rw_int_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
                                  <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferAllocator</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Allocate a new read-write integer buffer with OpenCL type mc_int_t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        owner: any</span>
<span class="sd">            Allocation owner / caller.</span>
<span class="sd">        shape: Tuple[int]</span>
<span class="sd">            Allocation buffer shape.</span>
<span class="sd">        download: bool</span>
<span class="sd">            Set to True if download is required after executing the kernel.</span>
<span class="sd">            The downloaded data will be passed to the :py:meth:`update_data`</span>
<span class="sd">            method of the owner.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        allocation: BufferAllocation</span>
<span class="sd">            The buffer allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_allocate_rw_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
                                          <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.append_r_int_lut"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.append_r_int_lut">[docs]</a>    <span class="k">def</span> <span class="nf">append_r_int_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LutEntry</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Append data to the integer type read-only lookuptable with</span>
<span class="sd">        The OpenCL data type of the read-only lookup table is mc_int_t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: np.ndarray</span>
<span class="sd">            Lookup table data to manage.</span>
<span class="sd">        force: bool</span>
<span class="sd">            If True, append the data array even if it is already managed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lut_entry: LutEntry</span>
<span class="sd">            Lookup table entry. Use the offset property to locate the</span>
<span class="sd">            first element of the entry in the lookup table buffer.</span>
<span class="sd">        new: bool</span>
<span class="sd">            True if a lookup table entry with the same data was not</span>
<span class="sd">            found among the existing managed lookup table entries.</span>
<span class="sd">            If the value of the force argument is True,</span>
<span class="sd">            this value is always returned as True.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_r_lut_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.append_r_float_lut"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.append_r_float_lut">[docs]</a>    <span class="k">def</span> <span class="nf">append_r_float_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">LutEntry</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Append data to the floating-point type read-only lookuptable.</span>
<span class="sd">        The OpenCL data type of the read-only lookup table is mc_float_t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: np.ndarray</span>
<span class="sd">            Lookup table data to manage.</span>
<span class="sd">        force: bool</span>
<span class="sd">            If True, append the data array even if it is already managed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lut_entry: LutEntry</span>
<span class="sd">            Lookup table entry. Use the offset property to locate the</span>
<span class="sd">            first element of the entry in the lookup table buffer.</span>
<span class="sd">        new: bool</span>
<span class="sd">            True if a lookup table entry with the same data was not</span>
<span class="sd">            found among the existing managed lookup table entries.</span>
<span class="sd">            If the value of the force argument is True,</span>
<span class="sd">            this value is always returned as True.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_r_lut_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.clear_r_float_lut"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.clear_r_float_lut">[docs]</a>    <span class="k">def</span> <span class="nf">clear_r_float_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clear the content of the floating point read-only lookup table manager.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">float_r_lut_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="ClWorkerStandardBufferLutMixin.clear_r_int_lut"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerStandardBufferLutMixin.clear_r_int_lut">[docs]</a>    <span class="k">def</span> <span class="nf">clear_r_int_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clear the content of the integer read-only lookup table manager.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_r_lut_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_np_r_float_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_buffers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_float</span><span class="p">)]</span>
    <span class="n">np_r_float_lut</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_np_r_float_lut</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Numpy data buffer of the read-only floating-point type lookup table.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_np_r_int_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_buffers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_lut_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">np_int</span><span class="p">)]</span>
    <span class="n">np_r_int_lut</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_np_r_int_lut</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Numpy data buffer of the read-only integer type lookup table.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClWorkerRngMixin"><a class="viewcode-back" href="../../../apidoc/xopto.mcbase.mcworker.html#xopto.mcbase.mcworker.ClWorkerRngMixin">[docs]</a><span class="k">class</span> <span class="nc">ClWorkerRngMixin</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ClWorker class mixin that can be used to create an OpenCl Random number</span>
<span class="sd">    generator.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Random number generator mixin for an OpenCL worker. Use the</span>
<span class="sd">        :py:attr:`rng` to access the random number generator and</span>
<span class="sd">        :py:attr:`cl_max_threads` to determine the maximum number</span>
<span class="sd">        of threads that can be run concurrently with this random number</span>
<span class="sd">        generator. The mutable seeeds can be accessed through the</span>
<span class="sd">        :py:attr:`rng_seeds_x` property and the immutable seeds through</span>
<span class="sd">        the :py:attr:`rng_seeds_a`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rnginit: np.uint64</span>
<span class="sd">            OpenCL random number generator initializer as a 64-bit unsigned</span>
<span class="sd">            integer.</span>
<span class="sd">            Use this initializer if there is a need to put the random, number</span>
<span class="sd">            generator into a known initial state. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">rnginit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rnginit&#39;</span><span class="p">)</span>
        <span class="c1"># Initialization of the Monte Carlo random number generator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">clrng</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rnginit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rnginit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="n">rnginit</span><span class="p">)</span>
        <span class="n">rng_seeds_x</span><span class="p">,</span> <span class="n">rng_seeds_a</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">seeds</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">maxseeds</span><span class="p">,</span> <span class="n">xinit</span><span class="o">=</span><span class="n">rnginit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">np_buffers</span><span class="p">[</span><span class="s1">&#39;rng_seeds_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng_seeds_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">np_buffers</span><span class="p">[</span><span class="s1">&#39;rng_seeds_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng_seeds_a</span>

        <span class="c1"># Maximum number of concurrent OpenCL threads that can be run with the</span>
        <span class="c1"># random number generator (total number of available seeds).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_max_threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">maxseeds</span><span class="o">//</span><span class="mi">512</span><span class="p">)</span><span class="o">*</span><span class="mi">512</span>

    <span class="k">def</span> <span class="nf">_get_rng_seeds_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_buffers</span><span class="p">[</span><span class="s1">&#39;rng_seeds_x&#39;</span><span class="p">]</span>
    <span class="n">rng_seeds_x</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_rng_seeds_x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="s1">&#39;Mutable random number generator seeds X.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_rng_seeds_a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_buffers</span><span class="p">[</span><span class="s1">&#39;rng_seeds_a&#39;</span><span class="p">]</span>
    <span class="n">rng_seeds_a</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_rng_seeds_a</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="s1">&#39;Immutable random number generator seeds A.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cl_max_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_max_threads</span>
    <span class="n">cl_max_threads</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cl_max_threads</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;The maximum number of OpenCl threads that can &#39;</span>
                             <span class="s1">&#39;be run concurrently with this random number &#39;</span>
                             <span class="s1">&#39;generator.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_rng</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">clrng</span><span class="o">.</span><span class="n">Random</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_rng</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Random number generator for OpenCL.&#39;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">TEST_CODE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
        <span class="s1">&#39;__kernel void test(int a, int b){&#39;</span><span class="p">,</span>
        <span class="s1">&#39;   int c = a + b;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;}&#39;</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">ClWorkerStandardBufferLutMixin</span><span class="p">,</span> <span class="n">ClWorker</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">types</span><span class="p">:</span> <span class="n">mctypes</span><span class="o">.</span><span class="n">McDataTypesBase</span> <span class="o">=</span> <span class="n">mctypes</span><span class="o">.</span><span class="n">McDataTypesSingle</span><span class="p">,</span>
                 <span class="n">options</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">mcoptions</span><span class="o">.</span><span class="n">McOption</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">cl_devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_build_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">cl_devices</span><span class="p">,</span> <span class="n">cl_build_options</span><span class="p">)</span>


    <span class="n">cw</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">cl_devices</span><span class="o">=</span><span class="s1">&#39;hd&#39;</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">cw</span><span class="o">.</span><span class="n">cl_build</span><span class="p">(</span><span class="n">TEST_CODE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, XOpto team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>